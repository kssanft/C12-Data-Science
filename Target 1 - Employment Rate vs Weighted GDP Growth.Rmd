---
title: "R Notebook"
output: html_notebook

---

Firstly, we need to install our various packages as well as load any libraries needed. 

```{r}
#install.packages("tidyverse")
#install.packages("ggthemes")
setwd("C:/Users/sheri/OneDrive/Desktop/Data Science Yr 1/Coursework/data sets")
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ggthemes)
```

Now, we can begin by downloading our CSV dataset files and having a quick look at that data that we have been provided as well as the additional csv files that have data on population and employment to population ratio.

The additional csv files have text in the first three rows which we do not require, therefore we use "skip =" to skip past these and begin reading the files at line 4. 

```{r}
gdp_per_capita <- read.csv("gdp-per-capita-worldbank.csv", stringsAsFactors = F)
continents <- read.csv("continents-according-to-our-world-in-data.csv", stringsAsFactors = F)
population_data <- read.csv("Population.csv", stringsAsFactors = F, skip = 3)
employment_to_pop <- read.csv("Employment_to_Population.csv", stringsAsFactors = FALSE, skip = 3)

View(gdp_per_capita)
View(continents)
View(population_data)
View(employment_to_pop)

```

Now we need to clean the Population csv file. When viewing the file, we noticed that the columns containing the years contains an X preceding it so we used gsub() to remove it. 

We also removed the last column as all its values are NA, as well as using the mutate function to ensure that values in Year and Population are stored as numeric. In addition, the gather function has been used to convert the data into a long format, and columns have been named to match those in the other csv files. Finally, The drop_na() method has been used to remove all rows that contain missing values. 

We use a similar approach for the Employment to Population Ratio csv file. This time, there are many more columns with missing values due to a lack of data from 1960 to 1990 so we use a vector to remove all of these columns.
```{r}
colnames(employment_to_pop) <- gsub("^X", "", colnames(employment_to_pop))
View(employment_to_pop)
employment_to_pop <-  employment_to_pop[,-(c(5:35, 70))]
View(employment_to_pop)
#View(population_data)
employment_long <- employment_to_pop %>%
  gather (key = "Year", value = "EmploymentRate", `1991`:`2024`) %>%
  drop_na() %>%
  mutate(
    Year = as.numeric(Year),
    EmploymentRate = as.numeric(EmploymentRate)
  ) %>%
  rename (
    Entity = Country.Name,
    Code = Country.Code
  )

View(employment_long)
```

```{r}
colnames(population_data) <- gsub("^X", "", colnames(population_data))
population_data <-  population_data[,-70]
#View(population_data)
population_long <- population_data %>%
  gather (key = "Year", value = "Population", `1960`:`2024`) %>%
  mutate(
    Year = as.numeric(Year),
    Population = as.numeric(Population)
  ) %>%
  rename (
    Entity = Country.Name,
    Code = Country.Code
  ) %>%
  drop_na()

View(population_long)
```

After loading the data, we also created a new dataframe called "gdp_per_capita2" that uses left_join to combine the the data sets together by matching up the data with the same country code. 

After grouping by Continent and Year, the weighted average of the GDP is calculated by using the weighted.mean() function and the average employment rate across a continent is also calculated using the mean() function. These are stored in the dataframe after the summarise() function is used to produce a singular value for each. 

Another dataframe is also created, "continent_growth", which includes a new column indicating each country's annual GDP growth rate. We grouped the data by continent and sorted it using the arrange() function, before calculating this value as the percentage change from the previous year's GDP using the mutate() and lag() functions. Additionally, because the lag() function produces an NA for the first year of each country (since there is no previous value to compare to), we removed these missing values before continuing our analysis.


```{r}

gdp_per_capita2 <- gdp_per_capita %>%
  rename(GDP_capita = GDP.per.capita..PPP..constant.2017.international... ) %>%
  left_join (continents %>% select (Code, Continent), by = "Code") %>%
  left_join (population_long %>% select (Code, Year, Population), by = c("Code", "Year")) %>%
  left_join(employment_long %>% select(Code, Year, EmploymentRate), by = c("Code", "Year")) %>%
  drop_na()

avg_gdp <- gdp_per_capita2 %>%
  group_by(Continent, Year) %>%
  summarise( 
    weighted_gdp = weighted.mean (GDP_capita, w = Population, na.rm = TRUE),
    employment = mean(EmploymentRate, na.rm = TRUE)
  ) 
  
#View(gdp_per_capita2)

continent_growth <- avg_gdp %>%
  group_by(Continent) %>%
  arrange(Year, Continent) %>%
  mutate(
    weighted_gdp_growth = (weighted_gdp - lag(weighted_gdp)) /
      lag(weighted_gdp) * 100
  ) %>%
  drop_na

View(continent_growth)
```

We now need to plot the weighted GDP growth rate against time, while also plotting the employment rate on a secondary y-axis. To do this for each continent, a function is created called plot_continent, where the data is filtered to extract the corresponding data for each continent. To plot the employment rate on the same graph as the weighted GDP growth rate, we need to scale values due to their differing range. This was done by referring to an example found on Finch Studio, which is referenced in the report.

This function calculates the scale for each continent based on the minimum and maximum values in the data extracted. It uses the sec_axis() function to create a secondary axis for the employment rate and then plots the data based on the limits and scale calculated earlier. The function is then run with each continent as a parameter. 


```{r}
plot_continent <- function(continent_name) {
  continent_data <- continent_growth %>% filter(Continent == continent_name)
  
  max_gdp  <- max(continent_data$weighted_gdp_growth, na.rm = TRUE)
  min_gdp  <- min(continent_data$weighted_gdp_growth, na.rm = TRUE)
  
  max_employment <- max(continent_data$employment, na.rm = TRUE)
  min_employment <- min(continent_data$employment, na.rm = TRUE)
  
  scale <- (max_employment - min_employment) / (max_gdp - min_gdp)
  shift <- min_employment - min_gdp * scale
  
  scale_function <- function(x, scale, shift) {
    return((x) * scale + shift)
  }
  
  inv_scale_function <- function(x, scale, shift) {
    return((x - shift) / scale)
  }
  
ggplot(continent_data, aes(x = Year)) +  
    geom_line(aes(y = weighted_gdp_growth, color = "GDP Growth (%)"), 
              linewidth = 1.25) +
    geom_line(aes(y = inv_scale_function(employment, scale, shift), 
              color = "Employment Rate (%)"), linewidth = 1.25, 
              linetype = "dashed", na.rm = TRUE) +
    labs( title = paste("GDP Growth vs Employment Rate in", continent_name, 
              sep= " "),x = "Year", colour = "Key") +
    scale_y_continuous(limits = c(min_gdp - 0.01, max_gdp + 0.01), 
              name = "GDP Growth(%)",
    sec.axis = sec_axis(~scale_function(., scale, shift),
               name = "Employment Rate (%)")) +
    scale_color_manual(values = c("GDP Growth (%)" = "darkblue",
                                  "Employment Rate (%)" = "darkred")) +
    theme_economist_white() +
    theme(
      text = element_text(size = 11),
      legend.title = element_text(size = 8),
      legend.text = element_text(size = 10)
    )
}

plot_continent("Africa")
plot_continent("Asia")
plot_continent("Europe")
plot_continent("North America")
plot_continent("Oceania")
plot_continent("South America")

```

